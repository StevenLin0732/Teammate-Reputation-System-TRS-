{% extends 'base.html' %}

{% block title %}TRS Â· Lobbies{% endblock %}

{% block content %}
  <div class="d-flex align-items-end justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1">Lobbies</h1>
      <div class="text-muted">Browse active lobbies and contest links.</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span class="badge text-bg-secondary">{{ lobbies|length }} total</span>
      {% if current_user %}
        <a class="btn btn-sm btn-primary" href="{{ url_for('create_lobby_page') }}">Create lobby</a>
      {% endif %}
    </div>
  </div>

  <div class="row g-3">
    {% for lobby in lobbies %}
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <h5 class="card-title mb-1">{{ lobby.title }}</h5>
              <div class="d-flex gap-1 flex-wrap justify-content-end">
                <span class="badge text-bg-primary">{{ lobby.participant_count }} members</span>
                {% if lobby.finished %}
                  <span class="badge text-bg-dark">Finished</span>
                {% endif %}
                {% if lobby.team_locked and (not lobby.finished) %}
                  <span class="badge text-bg-warning">Locked</span>
                {% endif %}
              </div>
            </div>
            <div class="text-muted small mb-3">&nbsp;</div>

            {% if lobby.contest_link %}
              <div class="small">
                <a class="text-decoration-none" href="{{ lobby.contest_link }}" target="_blank" rel="noopener noreferrer">
                  <i class="bi bi-paperclip me-1" aria-hidden="true"></i>
                  <span>{{ lobby.contest_link }}</span>
                </a>
              </div>
            {% endif %}

            <div class="mt-3 d-flex gap-2 flex-wrap">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('lobby_detail', lobby_id=lobby.id) }}">Open</a>

              {% if current_user %}
                {% if lobby.role %}
                  <button class="btn btn-sm btn-secondary" type="button" disabled>{{ lobby.role }}</button>
                {% elif (not lobby.finished) and (not lobby.team_locked) %}
                  {% if lobby.join_request_status == 'pending' %}
                    <button class="btn btn-sm btn-outline-secondary" type="button" disabled>Requested</button>
                  {% else %}
                    <form method="post" action="{{ url_for('create_join_request_page', lobby_id=lobby.id) }}">
                      <button class="btn btn-sm btn-outline-secondary" type="submit">Request to join</button>
                    </form>
                  {% endif %}
                {% endif %}
              {% endif %}
            </div>
          </div>
          <div class="card-footer bg-white border-top-0 pt-0">
            <div class="small text-muted">Lobby ID: {{ lobby.id }}</div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="col-12">
        <div class="alert alert-secondary mb-0">No lobbies found. Run the seed script to populate the DB.</div>
      </div>
    {% endfor %}
  </div>
{% endblock %}
