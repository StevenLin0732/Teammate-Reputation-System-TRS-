from datetime import datetime, timedelta

from app import app
from extensions import db
from models import User, Lobby, Team, Submission, Rating


def reset_db():
    db.drop_all()
    db.create_all()


def seed_users():
    users = [
        User(
            name="Alice Chen",
            major="CS",
            year="2027",
            bio="Backend-focused. Flask/FastAPI, SQLAlchemy, REST APIs. Strong at debugging and writing clean interfaces. Interested in hackathons and systems.",
            contact="GitHub: alicechen | LinkedIn: alice-chen | WeChat: alice_chen27",
            phone="+1-202-555-0101",
            email="alice.chen@example.com",
        ),
        User(
            name="Bob Zhang",
            major="Math",
            year="2026",
            bio="Algorithms + competitive programming. Comfortable with C++/Python, graph algorithms, DP, and complexity analysis. Reliable under deadlines.",
            contact="GitHub: bobzhang | WeChat: bob_algo",
            phone="+1-202-555-0102",
            email="bob.zhang@example.com",
        ),
        User(
            name="Cathy Liu",
            major="Data Science",
            year="2027",
            bio="Data/ML. Pandas, scikit-learn basics, evaluation metrics. Can build quick dashboards and data pipelines. Good communicator.",
            contact="GitHub: cathyliu | LinkedIn: cathy-liu-ds",
            phone="+1-202-555-0103",
            email="cathy.liu@example.com",
        ),
        User(
            name="David Wang",
            major="ECE",
            year="2026",
            bio="Frontend + UI. JavaScript, Bootstrap, basic React. Can translate requirements into simple, usable pages quickly. Enjoys rapid prototyping.",
            contact="GitHub: davidwang | Portfolio: davidwang.dev",
            phone="+1-202-555-0104",
            email="david.wang@example.com",
        ),
        User(
            name="Evan Zhou",
            major="Business",
            year="2028",
            bio="PM/operations. Clear planning, task breakdown, presentations, and pitch decks. Can help with product narrative and user research.",
            contact="LinkedIn: evan-zhou | WeChat: evan_pm",
            phone="+1-202-555-0105",
            email="evan.zhou@example.com",
        ),
        User(
            name="Fiona Xu",
            major="CS",
            year="2028",
            bio="UI/UX + frontend. Bootstrap layouts, forms, validation. Can make pages look consistent and demo-ready. Interested in human-centered design.",
            contact="GitHub: fionaxu | LinkedIn: fiona-xu",
            phone="+1-202-555-0106",
            email="fiona.xu@example.com",
        ),
        User(
            name="Grace Sun",
            major="Statistics",
            year="2027",
            bio="Evaluation + metrics. Survey design, simple experiments, A/B testing intuition. Can help define reputation scoring and fairness checks.",
            contact="LinkedIn: grace-sun-stats | WeChat: grace_stats",
            phone="+1-202-555-0107",
            email="grace.sun@example.com",
        ),
        User(
            name="Henry Lin",
            major="Physics",
            year="2026",
            bio="Systems-minded. Strong debugging, performance thinking, and careful testing. Can implement robust scripts and check edge cases.",
            contact="GitHub: henrylin | WeChat: henry_sys",
            phone="+1-202-555-0108",
            email="henry.lin@example.com",
        ),
        User(
            name="Iris Gao",
            major="CS",
            year="2027",
            bio="Full-stack learner. Flask, SQLite, APIs, and simple frontend. Good at connecting pieces and delivering working features.",
            contact="GitHub: irisgao | LinkedIn: iris-gao",
            phone="+1-202-555-0109",
            email="iris.gao@example.com",
        ),
        User(
            name="Jason He",
            major="Data Science",
            year="2026",
            bio="Data engineering basics. ETL, JSON, schema design, and validation. Can help keep database consistent and write small admin tools.",
            contact="GitHub: jasonhe | WeChat: jason_data",
            phone="+1-202-555-0110",
            email="jason.he@example.com",
        ),
        User(
            name="Kelly Tang",
            major="Media Arts",
            year="2028",
            bio="Design + storytelling. Can polish UI content, write onboarding copy, and improve demo flow. Strong collaboration and presentation skills.",
            contact="Portfolio: kellytang.design | WeChat: kelly_design",
            phone="+1-202-555-0111",
            email="kelly.tang@example.com",
        ),
        User(
            name="Leo Huang",
            major="CS",
            year="2026",
            bio="Backend + databases. SQL, schema modeling, and server logic. Comfortable with Flask, ORMs, and building small APIs for demos.",
            contact="GitHub: leohuang | LinkedIn: leo-huang",
            phone="+1-202-555-0112",
            email="leo.huang@example.com",
        ),
    ]
    db.session.add_all(users)
    db.session.commit()
    return users


def make_lobby(title, link, leader_id, finished=False, finished_days_ago=None):
    finished_at = None
    if finished and finished_days_ago is not None:
        finished_at = datetime.utcnow() - timedelta(days=finished_days_ago)
    lobby = Lobby(
        title=title,
        contest_link=link,
        leader_id=leader_id,
        finished=finished,
        finished_at=finished_at,
    )
    db.session.add(lobby)
    db.session.commit()
    return lobby


def make_team(lobby_id, locked=False, member_ids=None):
    team = Team(lobby_id=lobby_id, locked=locked)
    db.session.add(team)
    db.session.commit()
    for uid in (member_ids or []):
        team.add_member(uid)
    db.session.commit()
    return team


def add_submission(team_id, submitter_id, link):
    s = Submission(team_id=team_id, submitter_id=submitter_id, proof_link=link)
    db.session.add(s)
    db.session.commit()
    return s


def add_rating(team_id, rater_id, target_id, contrib, comm, wwa, comment):
    r = Rating(
        team_id=team_id,
        rater_id=rater_id,
        target_user_id=target_id,
        contribution=contrib,
        communication=comm,
        would_work_again=wwa,
        comment=comment,
    )
    db.session.add(r)


def pairwise_ratings(team_id, user_ids, base_contrib, base_comm, bias=None, tag=""):
    bias = bias or {}
    for rater in user_ids:
        for target in user_ids:
            if rater == target:
                continue
            bc = base_contrib + bias.get((rater, target), 0)
            bm = base_comm + bias.get((target, rater), 0)
            bc = max(1, min(10, int(bc)))
            bm = max(1, min(10, int(bm)))
            wwa = (bc + bm) >= 15
            comment = f"{tag} contrib={bc}, comm={bm}"
            add_rating(team_id, rater, target, bc, bm, wwa, comment)
    db.session.commit()


def seed_finished_lobby_a(users):
    u = {x.name: x for x in users}
    leader = u["Alice Chen"]
    m1 = u["Bob Zhang"]
    m2 = u["Cathy Liu"]
    m3 = u["David Wang"]

    lobby = make_lobby(
        "Hackathon A (Finished + Rated)",
        "https://example.com/hackathon-a",
        leader.id,
        finished=True,
        finished_days_ago=2,
    )
    team = make_team(lobby.id, locked=True, member_ids=[leader.id, m1.id, m2.id, m3.id])

    add_submission(team.id, leader.id, "https://devpost.com/software/teamrank-a")
    add_submission(team.id, m2.id, "https://github.com/demo/teamrank-a-proof")

    bias = {
        (m1.id, leader.id): 1,
        (m2.id, leader.id): 1,
        (m3.id, leader.id): 0,
        (leader.id, m1.id): 0,
        (leader.id, m2.id): 1,
        (leader.id, m3.id): -1,
    }
    pairwise_ratings(team.id, [leader.id, m1.id, m2.id, m3.id], base_contrib=8, base_comm=8, bias=bias, tag="HackathonA")


def seed_finished_lobby_d(users):
    leader = users[11]
    m1 = users[6]
    m2 = users[7]

    lobby = make_lobby(
        "Datathon D (Finished + Rated)",
        "https://example.com/datathon-d",
        leader.id,
        finished=True,
        finished_days_ago=1,
    )
    team = make_team(lobby.id, locked=True, member_ids=[leader.id, m1.id, m2.id])

    add_submission(team.id, leader.id, "https://devpost.com/software/teamrank-d")
    bias = {
        (m1.id, leader.id): 0,
        (m2.id, leader.id): 1,
        (leader.id, m1.id): 1,
        (leader.id, m2.id): 0,
    }
    pairwise_ratings(team.id, [leader.id, m1.id, m2.id], base_contrib=7, base_comm=7, bias=bias, tag="DatathonD")


def seed_open_lobbies(users):
    leader_b = users[3]
    lobby_b = make_lobby(
        "Hackathon B (Open Lobby)",
        "https://example.com/hackathon-b",
        leader_b.id,
        finished=False,
    )
    make_team(lobby_b.id, locked=False, member_ids=[leader_b.id, users[4].id, users[10].id])

    leader_c = users[5]
    lobby_c = make_lobby(
        "Contest C (Team Locked)",
        "https://example.com/contest-c",
        leader_c.id,
        finished=False,
    )
    make_team(lobby_c.id, locked=True, member_ids=[leader_c.id, users[8].id])

    leader_e = users[9]
    lobby_e = make_lobby(
        "MiniJam E (Open Lobby)",
        "https://example.com/minijam-e",
        leader_e.id,
        finished=False,
    )
    make_team(lobby_e.id, locked=False, member_ids=[leader_e.id])


def main():
    with app.app_context():
        reset_db()
        users = seed_users()
        seed_finished_lobby_a(users)
        seed_finished_lobby_d(users)
        seed_open_lobbies(users)
        print("Seed complete.")


if __name__ == "__main__":
    main()
